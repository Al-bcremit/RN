{"version":3,"names":["makeUIMutable","initial","syncDataHolder","listeners","Map","value","self","newValue","valueSetter","_value","_updateDataSynchronously","makeShareableCloneOnUIRecursive","forEach","listener","addListener","id","set","removeListener","delete","_animation","makeMutable","oneWayReadsOnly","NativeReanimatedModule","native","makeSynchronizedDataHolder","makeShareableCloneRecursive","registerShareableMapping","handle","__init","undefined","mutable","runOnUI","getDataSynchronously","Error","modify","modifier","makeRemote"],"sources":["mutables.ts"],"sourcesContent":["import NativeReanimatedModule from './NativeReanimated';\nimport { SharedValue, ShareableSyncDataHolderRef } from './commonTypes';\nimport {\n  makeShareableCloneOnUIRecursive,\n  makeShareableCloneRecursive,\n  registerShareableMapping,\n} from './shareables';\nimport { runOnUI } from './threads';\nimport { valueSetter } from './valueSetter';\nexport { stopMapper } from './mappers';\n\nexport function makeUIMutable<T>(\n  initial: T,\n  syncDataHolder?: ShareableSyncDataHolderRef<T>\n) {\n  'worklet';\n\n  const listeners = new Map();\n  let value = initial;\n\n  const self = {\n    set value(newValue) {\n      valueSetter(self, newValue);\n    },\n    get value() {\n      return value;\n    },\n    /**\n     * _value prop should only be accessed by the valueSetter implementation\n     * which may make the decision about updating the mutable value depending\n     * on the provided new value. All other places should only attempt to modify\n     * the mutable by assigning to value prop directly.\n     */\n    set _value(newValue: T) {\n      value = newValue;\n      if (syncDataHolder) {\n        _updateDataSynchronously(\n          syncDataHolder,\n          makeShareableCloneOnUIRecursive(newValue)\n        );\n      }\n      listeners.forEach((listener) => {\n        listener(newValue);\n      });\n    },\n    get _value(): T {\n      return value;\n    },\n    addListener: (id: number, listener: (newValue: T) => void) => {\n      listeners.set(id, listener);\n    },\n    removeListener: (id: number) => {\n      listeners.delete(id);\n    },\n    _animation: null,\n  };\n  return self;\n}\n\nexport function makeMutable<T>(\n  initial: T,\n  oneWayReadsOnly = false\n): SharedValue<T> {\n  let value: T = initial;\n  let syncDataHolder: ShareableSyncDataHolderRef<T> | undefined;\n  if (!oneWayReadsOnly && NativeReanimatedModule.native) {\n    // updates are always synchronous when running on web or in Jest environment\n    syncDataHolder = NativeReanimatedModule.makeSynchronizedDataHolder(\n      makeShareableCloneRecursive(value)\n    );\n    registerShareableMapping(syncDataHolder);\n  }\n  const handle = makeShareableCloneRecursive({\n    __init: () => {\n      'worklet';\n      return makeUIMutable(initial, syncDataHolder);\n    },\n  });\n  // listeners can only work on JS thread on Web and jest environments\n  const listeners = NativeReanimatedModule.native ? undefined : new Map();\n  const mutable = {\n    set value(newValue) {\n      if (NativeReanimatedModule.native) {\n        runOnUI(() => {\n          'worklet';\n          mutable.value = newValue;\n        })();\n      } else {\n        valueSetter(mutable, newValue);\n      }\n    },\n    get value() {\n      if (syncDataHolder) {\n        return NativeReanimatedModule.getDataSynchronously(syncDataHolder);\n      }\n      return value;\n    },\n    set _value(newValue: T) {\n      if (NativeReanimatedModule.native) {\n        throw new Error(\n          'Setting `_value` directly is only possible on the UI runtime'\n        );\n      }\n      value = newValue;\n      listeners!.forEach((listener) => {\n        listener(newValue);\n      });\n    },\n    get _value(): T {\n      if (NativeReanimatedModule.native) {\n        throw new Error(\n          'Reading from `_value` directly is only possible on the UI runtime'\n        );\n      }\n      return value;\n    },\n    modify: (modifier: (value: T) => T) => {\n      runOnUI(() => {\n        'worklet';\n        mutable.value = modifier(mutable.value);\n      })();\n    },\n    addListener: (id: number, listener: (value: T) => void) => {\n      if (NativeReanimatedModule.native) {\n        throw new Error('adding listeners is only possible on the UI runtime');\n      }\n      listeners!.set(id, listener);\n    },\n    removeListener: (id: number) => {\n      if (NativeReanimatedModule.native) {\n        throw new Error(\n          'removing listeners is only possible on the UI runtime'\n        );\n      }\n      listeners!.delete(id);\n    },\n  };\n  registerShareableMapping(mutable, handle);\n  return mutable;\n}\n\nexport function makeRemote<T extends object>(initial: T = {} as T): T {\n  const handle = makeShareableCloneRecursive({\n    __init: () => {\n      'worklet';\n      return initial;\n    },\n  });\n  registerShareableMapping(initial, handle);\n  return initial;\n}\n"],"mappings":"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"}